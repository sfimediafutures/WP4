<!DOCTYPE html>
<html>
<head>
  <title>VideoPositioning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <script src="https://mcorp.no/lib/mcorp-2.0.js"></script>
  <script src="https://mcorp.no/lib/mediasync.js"></script>
  <script src="https://webtiming.github.io/timingsrc/lib/timingsrc-v2.js"></script>

  <script src="app.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script>

    window.addEventListener("resize", function() {
      setTimeout(app.resize, 0);
    });

  </script>

  <style>
    body {
      height: 100%;
      width: 100%;
      margin: 0px;
      background: black;
    }
    .videocontainer {
      position: fixed;
      margin: 0px;
      width: 100%;
      height: 100%;
      overflow: hidden;
      //border: green 2px solid;
    }

    .videocontainer video {
      position: absolute;
    }

    .rightalign {
      text-align: right;
    }

    .subtitle {
      position: absolute;
      bottom: 60px;
      left: 30px;
      z-index: 20;
      background: rgba(0,0,0,0.5);
      color: white;
      font-size: 1.7em;
    }

    .subtitle.rightalign {
      right: 15% !important;
    }

    .overlay {
      position: absolute;
      bottom: 50px;
      left 10px;
      padding: 2%;
      width: 96%;
      background: green;
      font-size: 1.5em;
      z-index: 10;
    }

    .overlay .name {
      font-weight: bold;
      font-size: 1.5em;
    }

    .overlay .title {
      font-weight: italic;
      font-size: 1em;
    }

    .hidden {
      display: none;
    }

    .overlay {
      position: fixed;
      top: 0px;
      left: 0px;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      font-size: 2em;
      z-index: 10000000;
    }

    .markingbox {
      position: absolute;
      border: green 2px solid;
      width: 50px;
      height: 50px;
      z-index: 90;
      //transform: translate(-50%, -50%);
    }

    .pip {
      position: absolute;
      z-index: 1000;
      height: 100%;
      max-width: 40%;
      right: -80px;
      bottom: 0px;
      //height: 30%;
    }

    .controls {
      position: fixed;
      z-index: 100000;
      bottom: 0px;
      left: 0px;
      width: 100%;
      height: 50px;
      background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 40%, rgba(0,0,0,0.8) 100%);
      color: lightgray;
    }

    .controls .button {
      display: inline-block;
    }

    .controls .active {
      color: yellow;
    }

    .controls i {
      font-size: 48px;
    }

    .controls .spacer {
      display: inline-block;
      width: 50px;
    }

    .pipleft {
      left: -30px;
    }

    .pip.pipfixed {
      position: fixed;
      bottom: 0px;
      right: -40px;
      height: 100%;
      max-width: 50%;
    }
    video.landscape {
      height: 100%;
    }
    video.portrait {
      width: 100%;
    }
  </style>


</head>
<body>

<div class="overlay">
  <a href="#" id="playbtn">PLAY</a>
</div>

<div class="videocontainer">
<div class="markingbox hidden"></div>

<video class="pip hidden" src="../res/output.webm">
</video>

<div class="subtitle hidden"></div>
<div class="overlay hidden">
  <div class="name">
  </div>
  <div class="title">
  </div>
</div>
</div>

<div class="controls">
  <div class="button" id="btntrack"><i class="material-icons">center_focus_strong</i></div>
  <div class="button" id="btnpip"><i class="material-icons">person</i></div>
  <div class="button" id="btnpippos"><i class="material-icons  active">person_pin_circle</i></div>
  <div class="button" id="btnpos"><i class="material-icons  active">control_camera</i></div>
  <div class="spacer"></div>

  <div class="button" id="btnstart"><i class="material-icons">skip_previous</i></div>
  <div class="button" id="btnrev"><i class="material-icons">fast_rewind</i></div>
<!--  <div class="button" id="btnrev"><i class="material-icons">replay_15</i></div>-->
  <div class="button" id="btnplay"><i class="material-icons">play_arrow</i></div>
  <div class="button" id="btnpause"><i class="material-icons hidden">pause</i></div>
  <div class="button" id="btnff"><i class="material-icons">fast_forward</i></div>

  <div class="spacer"></div>
  <div class="button" id="btnsound"><i class="material-icons">volume_up</i></div>
  <div class="button" id="btnfs"><i class="material-icons">fullscreen</i></div>
  <div class="button" id="btn_nrktegnspraak"><i class="material-icons">accessibility</i></div>
  <div class="button" id="btn_nrktegnspraak_zoom"><i class="material-icons">zoom_in</i></div>
</div>

<script>

  document.querySelector("#playbtn").addEventListener("click", evt => {
    document.querySelector("video").play();
    document.querySelector(".overlay").style.display = "none";
  });

  let ctrltimeout;
  app.showControls = function(visible) {
    let ctrl = document.querySelector(".controls");
    if (visible === undefined) {
      // Auto
      if (ctrl.classList.contains("hidden")) {
        // Show but set timeout
        ctrltimeout = setTimeout(function() {app.showControls(false);}, 5000);
        // Show it
        ctrl.classList.remove("hidden");
      } else {
          ctrl.classList.add("hidden");
      }
    } else {
      if (visible) {        
        ctrl.classList.remove("hidden");
      } else {
        ctrl.classList.add("hidden");
      }
    }
  }

  app.to.on("change", function() {
    console.log("CHANGE", this.vel);
    if (this.vel == 0) {
      clearTimeout(ctrltimeout);
      app.showControls(true);
      document.querySelector("#btnplay i").classList.remove("hidden");
      document.querySelector("#btnpause i").classList.add("hidden");
    } else {
      app.showControls(false);
      document.querySelector("#btnpause i").classList.remove("hidden");
      document.querySelector("#btnplay i").classList.add("hidden");
    }
  })

  app.options.pip = false;
  app.options.pos = true;
  app.options.pippos = true;
  app.options.pipskew = true;

  let btns = {
    "btntrack": function(evt) { 
      let isActive = !evt.srcElement.classList.contains("active");
      console.log("Markings is now", app.options.markingbox);
      if (isActive) {
        document.querySelector(".markingbox").classList.remove("hidden");
        evt.srcElement.classList.add("active");
      } else {
        document.querySelector(".markingbox").classList.add("hidden");
        evt.srcElement.classList.remove("active");
      }
    },
    "btnpip": function(evt) {
      app.options.pip = !evt.srcElement.classList.contains("active");
      let pip = document.querySelector(".pip");
      if (app.options.pip) evt.srcElement.classList.add("active")
        else evt.srcElement.classList.remove("active");
      if (app.options.pip) {
        if (!pip.sync) {
          pip.sync = MCorp.mediaSync(pip, app.to, {skew: -6});
        }
        pip.classList.remove("hidden");          
      } else {
        if (pip) pip.classList.add("hidden");
      }
    },
    "btnpippos": function(evt) {
      app.options.pippos = !evt.srcElement.classList.contains("active");
      if (app.options.pippos) {
        evt.srcElement.classList.add("active");
        document.querySelector(".pip").classList.remove("pipfixed");
      } else {
        evt.srcElement.classList.remove("active");
        document.querySelector(".pip").classList.add("pipfixed");
        document.querySelector(".pip").classList.remove("pipleft");  // in case it's on the left
      }
    },
    "btnpos": function(evt) {
      app.options.pos = !evt.srcElement.classList.contains("active");
      app.options.pipskew = app.options.pos;
      if (app.options.pos) {
        evt.srcElement.classList.add("active");
      } else {
        evt.srcElement.classList.remove("active");
        // In case we used pipskew, return the width of the outer container
        app.videotarget.style.width = "100%";
        app.resize();
      }
    },
    "btnstart": function() { app.to.update({position:0, velocity: 0})},
    "btnrev": function() { app.to.update({position: Math.max(0, app.to.pos - 15)})},
    "btnplay": function() { app.to.update({velocity: 1})},
    "btnpause": function() { app.to.update({velocity: 0})},
    "btnff": function() { app.to.update({position: app.to.pos + 10})},

    "btnfs": function() {
      app.toggle_fullscreen(document.querySelector(".videocontainer"));
    },
    "btnsound": function(evt) { 
      let soundOn = !evt.srcElement.classList.contains("active");
      console.log("SoundOn:", soundOn);
      if (!soundOn) {
        document.querySelector(".maincontent").muted = true;
        evt.srcElement.classList.remove("active");
      } else {
        document.querySelector(".maincontent").muted = false;
        evt.srcElement.classList.add("active");
      }
    },
    "btn_nrktegnspraak": function(evt) {
      let on = !evt.srcElement.classList.contains("active");
      let pip = document.querySelector(".pip");
      let vid = app.videotarget.querySelector("video");
      console.log("NRK tegnspraak:", on);
      if (on) {
        if (!pip.sync) {
          pip.sync = MCorp.mediaSync(pip, app.to, {skew: -6});
        }
        pip.classList.remove("hidden");          
        pip.classList.add("pipfixed");          

        // No auto tracking
        app.options.pip = true;
        app.options.pippos = false;
        app.options.pos = false;
        document.querySelector("#btnpippos i").classList.remove("active");
        document.querySelector("#btnpip i").classList.add("active");
        document.querySelector("#btnpos i").classList.remove("active");



        evt.srcElement.classList.add("active");
        // Make PIP fixed on the side
        pip.style.height = "100%";
        pip.style.maxWidth = "40%";
        pip.style.position = "fixed";
        pip.style.right = "-80px";
        pip.style.bottom = "0px";
        setTimeout(function() {pip.style.left = ""; pip.style.top = "";}, 0);
        // Make video container smaller
        app.videotarget.style.width = "80%";
        app.videotarget.style.height = "80%";
        vid.style.left = "0px";
        vid.style.maxHeight = "100%";
        vid.style.maxWidth = "100%";
        vid.style.height = "100%";
        vid.style.top = "0px";
      } else {
        evt.srcElement.classList.remove("active");
        pip.classList.remove("pipfixed");          
        pip.style.width = "";
        pip.style.position = "";
        pip.style.right = "";
        pip.style.bottom = "";
        app.videotarget.style.width = "100%";
        app.videotarget.style.height = "100%";
        vid.style.left = "";
        vid.style.maxHeight = "";
        vid.style.maxWidth = "";
        vid.style.top = "";
        vid.style.height = "";
        app.resize();
      }
    },
    "btn_nrktegnspraak_zoom": function(evt) {
      let on = !evt.srcElement.classList.contains("active");
      let pip = document.querySelector(".pip");
      let vid = app.videotarget.querySelector("video");
      console.log("NRK tegnspraak:", on);
      if (on) {
        if (!pip.sync) {
          pip.sync = MCorp.mediaSync(pip, app.to, {skew: -6});
        }
        pip.classList.remove("hidden");          
        pip.classList.add("pipfixed");          
        // No auto tracking
        app.options.pip = true;
        app.options.pippos = false;
        document.querySelector("#btnpippos i").classList.remove("active");
        document.querySelector("#btnpip i").classList.add("active");

        evt.srcElement.classList.add("active");
        // Make PIP fixed on the side
        // Make video container smaller
        app.videotarget.style.width = "80%";
      } else {
        pip.classList.remove("pipfixed");          
        evt.srcElement.classList.remove("active");
        app.videotarget.style.width = "100%";
        app.resize();
      }
    }
  }

  for (let btn in btns) {
    document.querySelector("#" + btn).addEventListener("click", btns[btn]);
  }


  app.sequencer.on("change", function(evt) {

    let align = function(element, align) {
      console.log("Align", element, align);
      if (!element) return;
      if (align === "right") {
        element.classList.add("rightalign")
      } else {
        element.classList.remove("rightalign")
      }
    };

    let itm = evt.data;
    if (itm.pos) {
      console.log("Got POS", itm.pos, itm.target);
      let target = document.querySelector(itm.target);
      target.pos = itm.pos;
      target.animate = itm.animate;
      app.resize(document.querySelector(itm.target));
    }

    if (itm.text) {
      align(app.set_subtitle(itm.text), itm.align);
    }

    if (itm.overlay) {
      align(app.set_overlay(itm.overlay), itm.align);
    }

    /*
    if (app.options.markingbox) {
      let box = document.querySelector(".markingbox");
      box.style.left = itm.pos[0] + "%";
      box.style.top = itm.pos[1] + "%";
    }
*/
  });


  app.sequencer.on("remove", function(evt) {
    let itm = evt.data;
    if (itm.text) {
      app.set_subtitle("");;
    }
    if (itm.overlay) {
      app.set_overlay();
    }
  });

  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  app.load("Valkyrien_s01e01.json?ts=" + new Date().getTime() , ".videocontainer")
  .then(evt => {
    document.querySelector(".maincontent").muted = true;
    document.querySelector(".maincontent").addEventListener("click", evt => {
      console.log("CLICKED");
      app.toggle_fullscreen(document.querySelector(".videocontainer"), true);
      app.showControls();
    });
  });

  document.querySelector("body").addEventListener("keydown", evt => {
      let delta = 15;
      if (evt.ctrlKey) delta = 60;
      if (evt.shiftKey) delta = 1;

    if (evt.keyCode == 32) {
      evt.preventDefault();
      if (app.to.vel == 0) {
        app.to.update({velocity: 1});
      } else {
        app.to.update({velocity: 0, position: app.to.pos - 0.2});
      }
    } else if (evt.keyCode == 37) {
      app.to.update({position: app.to.pos - delta});
    } else if (evt.keyCode == 39) {
      app.to.update({position: app.to.pos + delta});
    }
  });


  // app.load("StaticNisse.js?ts=" + new Date().getTime() , ".videocontainer");
</script>
</body>
</html>